# Часто задаваемые вопросы и устранение неполадок

**Язык**: [English](./07_troubleshooting.md) | [简体中文](./07_troubleshooting_CN.md) | [繁體中文](./07_troubleshooting_TW.md) | Русский | [فارسی](./07_troubleshooting_FA.md)

При возникновении проблем первым делом проверьте журналы служб — это обычно позволяет быстро установить причину:

```bash
# Журнал EzPanel
sudo journalctl -u ezpanel -n 100 --no-pager

# Журнал XrayM
sudo journalctl -u xraym -n 100 --no-pager

# Журнал ошибок Nginx
sudo tail -n 50 /var/log/nginx/error.log
```

---

## Проблемы с установкой и запуском

### Служба не запускается

**Симптом**: `systemctl status ezpanel` показывает `failed` или `activating`

**Шаги диагностики**:

```bash
sudo journalctl -u ezpanel -n 50
```

Распространённые причины:

| Сообщение об ошибке | Причина | Решение |
|--------------------|---------|---------|
| `dial tcp: connection refused` | База данных не запущена | `systemctl start mysql` |
| `Access denied for user` | Неверный пароль базы данных | Проверьте `database.password` в `config.yaml` |
| `Unknown database` | База данных не создана | Создайте базу данных вручную; см. [Установка и развёртывание](./01_installation_RU.md) |
| `bind: address already in use` | Порт занят | Измените `server.port` или освободите занятый процесс |
| `invalid configuration` | Ошибка формата файла конфигурации | Проверьте отступы YAML; не используйте символы Tab |

### Таблицы базы данных не создаются автоматически

EzPanel создаёт таблицы автоматически при первом запуске. Убедитесь в следующем:

1. Пользователь базы данных имеет право `CREATE TABLE`
2. База данных создана заранее (система не создаёт саму базу данных автоматически)
3. В журнале нет ошибок подключения к базе данных

```sql
-- Проверить права пользователя
SHOW GRANTS FOR 'ezpanel'@'localhost';
```

---

## Проблемы с входом и аутентификацией

### Невозможно войти / забыт пароль

Попробуйте войти с учётными данными по умолчанию:
- Email: `admin@opine.work`
- Пароль: `admin123`

Если учётные данные по умолчанию также не работают, измените пароль напрямую в базе данных:

```bash
# Сгенерировать bcrypt-хэш нового пароля (требуется htpasswd)
htpasswd -nbBC 10 "" "new_password" | tr -d ':\n'

# Или с помощью Python
python3 -c "import bcrypt; print(bcrypt.hashpw(b'new_password', bcrypt.gensalt(10)).decode())"
```

```sql
UPDATE users SET password = '$2a$10$...' WHERE email = 'admin@opine.work';
```

### Токен часто недействителен

Причина: после перезапуска сервера JWT-ключ мог измениться, либо установлен слишком короткий срок действия токена.

Решение:
1. Убедитесь, что `jwt.secret` зафиксирован в `config.yaml` (не используйте случайно генерируемый)
2. Увеличьте значение `jwt.expire` (по умолчанию 168 часов = 7 дней)

### Код 2FA недействителен

Возможная причина: время на сервере и на телефоне не синхронизированы (TOTP требует точного совпадения времени)

```bash
# Синхронизировать время сервера
sudo timedatectl set-ntp true
timedatectl status
```

---

## Проблемы с базой данных

### Ошибка подключения к базе данных

```bash
# Проверить, запущен ли MySQL
systemctl status mysql

# Проверить подключение
mysql -u ezpanel -p -h 127.0.0.1 ezpanel -e "SELECT 1;"
```

Распространённые причины:
- Служба MySQL не запущена
- Неверное имя пользователя / пароль
- Указанная база данных не существует
- Брандмауэр блокирует порт 3306 (при удалённом подключении)

### Низкая производительность базы данных

```sql
-- Просмотр медленных запросов
SHOW VARIABLES LIKE 'slow_query_log';
SHOW GLOBAL STATUS LIKE 'Slow_queries';

-- Просмотр текущих соединений
SHOW PROCESSLIST;

-- Просмотр состояния InnoDB
SHOW ENGINE INNODB STATUS\G
```

Увеличьте `innodb_buffer_pool_size` (рекомендуется 50–70% от объёма памяти) и перезапустите MySQL.

---

## Проблемы с подключением узлов

### Узел не может подключиться к панели

**Шаги диагностики**:

1. Проверьте правильность адреса панели и ключа API
2. Проверьте сетевую доступность с сервера узла:
   ```bash
   curl -v https://panel.example.com/api/v1/server/UniProxy/config?node_id=1 \
     -H "Authorization: Bearer your-node-api-key"
   ```
3. Убедитесь, что панель принимает запросы с IP-адреса узла (настройки брандмауэра / Cloudflare)
4. Просмотрите журнал XrayM:
   ```bash
   journalctl -u xraym -f
   ```

### Данные мониторинга узла не отображаются

1. Убедитесь, что используется XrayM (XrayR не поддерживает мониторинг)
2. Убедитесь, что в `config.yaml` установлено `node.report_metrics: true`
3. Проверьте журнал XrayM на наличие ошибок, связанных с `report`

### Пользователи не могут подключиться к узлу

Порядок диагностики:

1. Убедитесь, что служба узла запущена: `systemctl status xraym`
2. Убедитесь, что порты узла открыты в брандмауэре
3. Проверьте, обновлена ли ссылка на подписку (клиент повторно получил подписку)
4. Просмотрите журнал XrayM на наличие ошибок подключения

```bash
# Проверить, прослушивается ли порт
ss -tlnp | grep 443

# Проверить доступность порта (с клиентской стороны)
nc -zv node.example.com 443
```

### Горячее обновление конфигурации XrayM не применяется

XrayM отслеживает изменения файла конфигурации и перезагружает его автоматически. Если обновление не применяется:

```bash
# Перезапустить вручную
sudo systemctl restart xraym
sudo journalctl -u xraym -f
```

---

## Проблемы с интерфейсом и функциями

### Страница отображает ошибку 502 Bad Gateway

Причина: служба EzPanel не запущена или неверно настроен обратный прокси Nginx.

```bash
# Проверить, запущен ли EzPanel
systemctl status ezpanel
curl http://127.0.0.1:7088/api/v1/health

# Проверить конфигурацию Nginx
nginx -t
```

### Ошибка загрузки файлов

1. Проверьте права доступа к каталогу загрузки:
   ```bash
   ls -la /var/lib/ezpanel/upload/
   # Должен принадлежать ezpanel:ezpanel
   sudo chown -R ezpanel:ezpanel /var/lib/ezpanel/upload/
   ```
2. Проверьте ограничения на размер загружаемых файлов:
   - `upload.max_size` в `config.yaml`
   - `client_max_body_size` в Nginx:
     ```nginx
     client_max_body_size 20m;
     ```

### Ошибка отправки электронной почты

1. Проверьте настройки SMTP (Панель управления → Системные настройки → Настройки электронной почты)
2. Используйте функцию «Отправить тестовое письмо» для проверки
3. Распространённые проблемы:
   - Для Gmail необходимо использовать «Пароль приложения», а не пароль аккаунта
   - Некоторые провайдеры требуют явного включения SMTP
   - Проверьте, не занесён ли IP сервера в чёрный список почтовых провайдеров

### Функции профессиональной версии не отображаются

1. Убедитесь, что `ezpanel-pro` установлен:
   ```bash
   which ezpanel-pro
   systemctl status ezpanel
   ```
2. Убедитесь, что конфигурация `commercial` в `config.yaml` раскомментирована
3. Убедитесь, что файл лицензии существует и имеет правильный формат:
   ```bash
   cat /etc/ezpanel/license.json
   ```
4. Проверьте журнал на наличие ошибок, связанных с лицензией:
   ```bash
   journalctl -u ezpanel -n 50 | grep -i "license\|commercial"
   ```

---

## Проблемы с производительностью

### Панель управления отвечает медленно

**Диагностика**:

```bash
# Просмотр нагрузки на систему
top
htop

# Просмотр использования памяти
free -h

# Просмотр операций ввода-вывода диска
iostat -x 1

# Просмотр медленных API (после включения журнала debug)
journalctl -u ezpanel | grep "latency"
```

**Распространённые меры оптимизации**:

1. Включить кэш Redis
2. Снизить уровень журналирования до `warn`
3. Увеличить пул соединений с базой данных
4. Настроить `innodb_buffer_pool_size` для MySQL
5. Убедиться в нормальной работе дискового ввода-вывода (SSD предпочтительнее HDD)

### Недостаточно памяти

```bash
# Просмотр потребления памяти
ps aux --sort=-%mem | head -20
```

- Основной процесс EzPanel обычно потребляет около 50–200 МБ
- При нехватке памяти рассмотрите возможность обновления сервера или отключения Swagger (`swagger.enable: false`)

---

## Сброс учётной записи администратора

Если все учётные записи администратора недоступны, можно напрямую изменить базу данных:

```sql
-- Найти учётные записи администратора
SELECT id, email, is_admin FROM users WHERE is_admin = 1;

-- Сбросить пароль до admin123
UPDATE users
SET password = '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi'
WHERE email = 'admin@opine.work';

-- Разблокировать учётную запись
UPDATE users SET banned = 0 WHERE email = 'admin@opine.work';
```

> Хэш пароля `$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi` соответствует паролю `password` в открытом виде. После входа немедленно смените пароль.

---

## Получение помощи

Бесплатная версия EzPanel не имеет официальной технической поддержки. Если вам нужна помощь, вы можете:

1. Обратиться к сообществу через Telegram-группу [@OpineWorkOfficial](https://t.me/OpineWorkOfficial)
2. Приобрести профессиональную или коммерческую версию для получения официальной поддержки: [https://opine.work](https://opine.work)
