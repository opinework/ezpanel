# Руководство по настройке

**Язык**: [English](./02_configuration.md) | [简体中文](./02_configuration_CN.md) | [繁體中文](./02_configuration_TW.md) | Русский | [فارسی](./02_configuration_FA.md)

Основной файл конфигурации EzPanel расположен по пути `/etc/ezpanel/config.yaml`.

---

## Полный справочник конфигурации

```yaml
# ================================
# EzPanel 配置文件
# ================================

# Настройки сервера
server:
  host: "0.0.0.0"        # Адрес прослушивания; 0.0.0.0 означает все интерфейсы
  port: 7088              # Порт прослушивания, по умолчанию 7088
  mode: "release"         # Режим работы: debug / release / test

# Настройки базы данных (обязательно)
database:
  host: "127.0.0.1"
  port: 3306
  user: "ezpanel"
  password: "your_password"
  dbname: "ezpanel"
  charset: "utf8mb4"
  max_idle_conns: 10      # Максимальное количество неактивных соединений
  max_open_conns: 100     # Максимальное количество открытых соединений

# Настройки Redis (опционально)
redis:
  host: "127.0.0.1"
  port: 6379
  password: ""
  db: 0

# Настройки JWT
jwt:
  secret: "change-this-to-a-random-string"  # Обязательно измените!
  expire: 168             # Время жизни токена (в часах), 168 = 7 дней
  issuer: "ezpanel"

# Настройки журналирования
log:
  level: "warn"           # Уровень журнала: debug / info / warn / error
  format: "console"       # Формат вывода: json / console
  output: "stdout"        # Место вывода: stdout / file / both
  file_path: "/var/log/ezpanel/app.log"

# Документация Swagger API
swagger:
  enable: false           # Рекомендуется отключить в производственной среде

# Мониторинг узлов (XrayM)
node:
  report_metrics: true    # Включить отправку данных мониторинга узла

# Настройки загрузки файлов
upload:
  path: "/var/lib/ezpanel/upload"
  max_size: 10            # Максимальный размер одного файла (МБ)
  allowed_types:
    - image/jpeg
    - image/png
    - image/gif
    - image/webp

# Настройки CORS
cors:
  allow_origins:
    - "*"                 # В производственной среде замените на реальный домен, например https://panel.example.com
  allow_credentials: true
  max_age: 12

# Коммерческий модуль (версия Pro / Enterprise)
# commercial:
#   pro_binary_path: "/usr/bin/ezpanel-pro"
#   license_path: "/etc/ezpanel/license.json"
#   socket_path: "/run/ezpanel/commercial.sock"
```

---

## Описание параметров конфигурации

### server

| Параметр | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| `host` | `0.0.0.0` | Адрес прослушивания. Для доступа только с локального хоста (через обратный прокси Nginx) измените на `127.0.0.1` |
| `port` | `7088` | Порт прослушивания |
| `mode` | `release` | Режим `debug` выводит подробные журналы; используйте `release` в производственной среде |

### database

| Параметр | Описание |
|----------|----------|
| `host` | Адрес хоста MySQL |
| `port` | Порт MySQL, по умолчанию 3306 |
| `user` | Имя пользователя базы данных |
| `password` | Пароль базы данных |
| `dbname` | Имя базы данных (необходимо создать заранее вручную) |
| `max_open_conns` | Максимальное количество соединений; настройте в соответствии с конфигурацией сервера, рекомендуется 50–200 |

### redis

Redis является необязательным компонентом. При его отсутствии система продолжает работать, но следующие функции недоступны:

- Ускорение с помощью распределённого кэша
- Глобальное межузловое ограничение устройств XrayM

### jwt

| Параметр | Описание |
|----------|----------|
| `secret` | Секретный ключ подписи JWT. **Необходимо заменить на случайную строку** — утечка ключа создаёт угрозу безопасности |
| `expire` | Срок действия токена (в часах); изменение не влияет на уже выданные токены до их истечения |

Генерация случайного ключа:
```bash
openssl rand -hex 32
```

### log

| Уровень | Описание | Сценарий использования |
|---------|----------|------------------------|
| `debug` | Выводит все журналы, включая SQL-запросы | Локальная разработка и отладка |
| `info` | Выводит общую информацию | Тестовая среда |
| `warn` | Выводит только предупреждения и ошибки | **Рекомендуется для производственной среды** |
| `error` | Выводит только ошибки | Стабильная производственная среда |

---

## Системные настройки в панели управления

Следующие параметры перенесены в **Панель управления → Системные настройки** и не требуют указания в файле конфигурации:

### Информация о сайте

- Название и логотип сайта
- URL сайта, URL подписки
- Настройки регистрации (открытая регистрация, инвайт-коды)

### Почта (SMTP)

- Адрес и порт SMTP-сервера
- Имя пользователя и пароль
- Адрес отправителя
- Управление почтовыми шаблонами

### Telegram Bot (опционально)

1. Создайте бота в [@BotFather](https://t.me/BotFather) и получите токен
2. Введите токен бота в панели управления
3. Нажмите «Установить Webhook» для завершения настройки

Пользователи могут привязать аккаунт следующими командами:
- `/bindaccount` — инициировать привязку
- `/bindcode <код>` — завершить привязку
- `/bindstatus` — проверить статус привязки

### Платёжный шлюз (версия Pro)

Настройки оплаты управляются в разделе «Панель управления → Настройки оплаты». Поддерживаются:

| Тип | Описание |
|-----|----------|
| EPay | Агрегированная платёжная платформа, поддерживает Alipay, WeChat и другие. Рекомендуется |
| Alipay (личный QR-код) | Оплата по QR-коду |
| Alipay (веб-оплата) | Перенаправление на страницу оплаты |
| WeChat Pay | Нативная оплата по QR-коду |
| Stripe | Международные кредитные карты |

### Ключ API узла

Ключ API, используемый для связи между узлами и панелью. Просмотр и изменение: Панель управления → Системные настройки → Ключ API узла.

---

## Развёртывание нескольких экземпляров

Для запуска нескольких экземпляров панели на одном сервере достаточно изменить порт и каталог конфигурации для каждого экземпляра:

```yaml
# Конфигурация экземпляра 2
server:
  port: 7089

database:
  dbname: "ezpanel2"
```

Затем создайте соответствующий файл службы systemd.
